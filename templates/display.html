<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Redistrictinator</title>
    <style>
        #map {
            height: 700px;
            width: 900px;
        }
    </style>
</head>
<body>
    <form name="display" action="{{ url_for('my_link') }}" method='POST'>
        <input type="submit" value="Start Over" onclick="" />
    </form>
    <div id="map"></div>
    <script>

        var map;
        var state;
        var num_districts;
        var districts;
        var zips;
        var largest_zips;
        var zoom_num;
        var center_lat;
        var center_long;
        var district_coordinates;
        var infoWindow;
        var zip_polys = {};
        var districts_pops;

        function initMap() {
            states = {'Alabama' : [7, 32.806671, -86.791130],
                      'Arkansas' : [7, 34.969704, -92.373123],
                      'Arizona' : [7, 33.972422, -111.431221],
                      'California' : [6, 36.116203, -119.681564],
                      'Colorado' : [7, 39.059811, -105.311104],
                      'Connecticut' : [9, 41.597782, -72.755371],
                      'Deleware' : [9, 39.1111111, -75.507141],
                      'Florida' : [7, 27.766279, -81.686783],
                      'Georgia' : [7, 33.040619, -83.643074],
                      'Idaho' : [6, 44.240459, -114.478828],
                      'Illinois' : [7, 39.900001, -88.986137],
                      'Indiana' : [7, 39.849426, -86.258278],
                      'Iowa' : [7, 42.011539, -93.210526],
                      'Kansas' : [7, 38.526600, -97.532345],
                      'Kentucky' : [7, 37.668140, -84.670067],
                      'Louisiana' : [7, 31.169546, -91.867805],
                      'Maine' : [7, 45.000001, -69.381927], 
                      'Maryland' : [8, 39.084000, -77.152800], 
                      'Massachusetts' : [8, 42.230171, -71.530106],
                      'Michigan' : [7, 43.326618,	-84.536095],
                      'Minnesota' : [6, 45.694454,	-93.900192],
                      'Mississippi' : [7, 32.741646,	-89.678696],
                      'Missouri' : [7, 38.456085,	-92.288368],
                      'Montana' : [6, 46.921925,	-110.454353],
                      'Nebraska' : [7, 41.125370,	-99.268082],
                      'Nevada' : [6, 38.313515,	-117.055374],
                      'New Hampshire' : [8, 43.986254,	-71.563896],
                      'New Jersey' : [8, 40.298904,	-74.521011],
                      'New Mexico' : [7, 34.000001,	-106.248482],
                      'New York' : [7, 43.048111,	-76.147411],
                      'North Carolina' : [7, 35.630066,	-79.806419],
                      'North Dakota' : [7, 47.528912,	-99.784012],
                      'Ohio' : [7, 40.388783,	-82.764915],
                      'Oklahoma' : [7, 35.565342,	-96.928917],
                      'Oregon' : [6, 44.572021,	-122.070938],
                      'Pennsylvania' : [7, 40.590752,	-77.209755],
                      'Rhode Island' : [9, 41.680893,	-71.511780],
                      'South Carolina' : [7, 33.856892,	-80.945007],
                      'South Dakota' : [7, 44.299782,	-99.438828],
                      'Tennessee' : [7, 35.747845,	-86.692345],
                      'Texas' : [6, 31.054487,	-97.563461],
                      'Utah' : [7, 39.705778,	-111.862434],
                      'Vermont' : [8, 44.045876,	-72.710686],
                      'Virginia' : [7, 37.769337,	-79.169968],
                      'Washington' : [7, 47.400902,	-121.490494],
                      'West Virginia' : [7, 38.491226,	-80.954453],
                      'Wisconsin' : [7, 44.768543,	-89.616508],
                      'Wyoming' : [7, 42.755966,	-107.302490],
                    };
            state = '{{ state }}';
            num_districts = '{{ num_districts }}';
            districts = JSON.parse('{{ districts|safe }}');
            zips = JSON.parse('{{ zips|safe }}');
            largest_zips = JSON.parse('{{ largest_zips|safe }}');
            districts_pops = JSON.parse('{{ districts_pops|safe }}');
                
            zoom_num = states[state][0];
            center_lat = states[state][1];
            center_long = states[state][2];

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: zoom_num,
                center: {lat: center_lat, lng: center_long},
            });

            
            district_coordinates = [];
            for (i = 0; i < num_districts; i++){
                var district_zips = districts['District ' + (i+1)];

                console.log(num_districts);
                console.log(i);
                console.log(district_zips);

                var single_coords = [];

                for (x = 0; x < district_zips.length; x++){
                    var boundary_list = [];
                    var boundary = zips[district_zips[x]];
                    
                    for (t = 0; t < boundary.length; t++){
                        boundary_list.push(boundary[t].slice(0,-4));
                    }
                    
                    single_coords.push(boundary_list);
                }

                district_coordinates.push(single_coords);
            }

            var polygons = [];
            colors = ['#B8860B','#696969','#FF1493','#8B0000','#FF7F50','#32CD32','#0000CD','#9400D3','#FA8072',
            '#6B8E23','#20B2AA','#FF69B4','#DC143C','#8A2BE2','#556B2F','#ADFF2F','#006400','#4682B4','#DA70D6',
            '#E9967A','#9370DB','#FF4500','#87CEFA','#C0C0C0','#C71585','#BDB76B','#FFDEAD','#800000','#191970',
            '#E6E6FA','#008080','#FF8C00','#DEB887','#CD5C5C','#FFFFFF','#000000','#808000','#8B4513','#F0E68C',
            '#FF0000','#00FFFF','#8B008B','#FFB6C1','#90EE90','#2E8B57','#BC8F8F','#48D1CC','#5F9EA0','#DDA0DD',
            '#FFA500','#FFFF00','#AFEEEE']
            console.log(colors.length);

            for (i = 0; i < district_coordinates.length; i++){

                var shapeCoords = [];

                for (x = 0; x < district_coordinates[i].length; x++){
                    var temp = [];
                    for (z = 0; z < district_coordinates[i][x].length; z++){
                        var parts = district_coordinates[i][x][z].split(',');
                        temp2 = {lat: parseFloat(parts[1]), lng: parseFloat(parts[0])};
                        temp.push(temp2);
                    }
                    shapeCoords.push(temp);
                }
            
                zip_polys['District ' + (i+1)] = shapeCoords;

                // Construct the polygon.
                polygons.push(new google.maps.Polygon({
                    paths: shapeCoords,
                    strokeColor: colors[i],
                    strokeOpacity: 0.0,
                    strokeWeight: 0,
                    fillColor: colors[i],
                    fillOpacity: 0.75
                }));
  
                polygons[i].setMap(map);

                polygons[i].addListener('mouseover', function() {
                    var vertices = this.getPath();
                    var district_id;

                    for (f = 0; f < num_districts; f++){
                        arr = zip_polys['District ' + (f+1)];

                        for (d = 0; d < arr.length; d++){

                            for (j = 0; j < arr[d].length; j++){

                                var l_lat = arr[d][j]['lat'];
                                var l_lng = arr[d][j]['lng'];

                                for (h = 0; h < vertices.getLength(); h++){
                                    verts = vertices.getAt(h);

                                    if ((l_lat == verts.lat()) && (l_lng == verts.lng())){
                                        district_id = 'District ' + (f+1);
                                    }
                                }
                            }
                        }
                    }
                    if (typeof largest_zips[district_id] == 'undefined'){
                        console.log('Undefined here');
                        console.log('District id: ' + district_id);
                    }
                    console.log(district_id);
                    var lst = largest_zips[district_id];
                    var l_zip = lst[0];
                    var coords = lst[1];
                    var highest = {lat: coords[0], lng: coords[1]};

                    var contentString = district_id + '<br><br>Largest zip code in district:<br>' + l_zip.toString() +
                    '<br><br> Total population:<br>' + districts_pops[district_id];
                    
                    infoWindow.setContent(contentString);
                    infoWindow.setPosition(highest);
                    infoWindow.open(map);
                });
            }

            infoWindow = new google.maps.InfoWindow;
        }

        function hideArrays(event) {
            //infoWindow.close();
        }

        function showArrays(event) {
            infoWindow.setContent('District 1');
            infoWindow.setPosition(event.latLng);
            infoWindow.open(map);
        }
        
    </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB154Xg4SR9Fjq9o-ty7ZZXLpumsDrOgKw&callback=initMap"></script>
    </body>
</html>